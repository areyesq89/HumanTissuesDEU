---
title: "Analysis related to Figure 3"
author: "Alejandro Reyes"
date: "`r BiocStyle::doc_date()`"
package: "`r BiocStyle::pkg_ver('HumanDEU')`"
output:
  BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{HumanDEU}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r style, echo=FALSE, results='asis'}
BiocStyle::markdown()
```

# Analysis of variance of REUCs and RSICs

Loading all the data from the HumanDEU package.

```{r calculations, message=FALSE}

library( DEXSeq )
library( dplyr )
library( HumanDEU )
data( "resultsDF" )
data( "crossCoefs1", "crossCoefs2", "crossCoefs3", "crossCoefsJR1", "crossCoefsJR2", "crossCoefsJR3" )

```

With the function below, we fit a linear model on the REUCs and the RSICs 
using the tissues and individuals as categorical predictors. Then,
this function calculates the coefficients of partial determination of these fits
on each of the *GTEx* datasets. 


```{r}

estimateR2 <- function( crossCoefs, statistic, subset, BPPARAM=SerialParam() ){
    df <- data.frame(
        individual=rep( rownames(crossCoefs[1,,]), ncol( crossCoefs[1,,] ) ),
        tissue=rep( colnames(crossCoefs[1,,]), each=nrow( crossCoefs[1,,] ) ),
        stringsAsFactors=FALSE )
    df$reuc <- NA
    r2 <- bplapply( seq_along(dimnames(crossCoefs)[["exon"]]),
                   function(x, dfL){
                       df$reuc <- as.vector(crossCoefs[x,,])
                       if( any( is.na( df$reuc ) ) ){
                           return(rep(NA, 3))
                       }else{
                           anovaRes <- anova( lm( reuc ~ individual + tissue, df ) )
                           beta <- anovaRes[c("individual", "tissue", "Residuals"),"Sum Sq"]
                           return( beta )
                       }
                   }, dfL=df, BPPARAM=BPPARAM )
    res <- do.call(rbind, r2)
    colnames(res) <- c("individual", "tissue", "residuals")
    rownames(res) <- dimnames(crossCoefs)[["exon"]]
    res <- as.data.frame( res )
    res$statistic <- statistic
    res$subset <- subset
    res$exon <- rownames(res)
    res
}
```

However, since this calculations would take long to complete, this package provides
the precomputed results. These results were generated by running the code below.

```{r, eval=FALSE}

#BPPARAM <- SnowParam(7)
BPARAM <- SerialParam()
varExplained1 <- estimateR2( crossCoefs1, "REUC", "subsetA", BPPARAM )
varExplained2 <- estimateR2( crossCoefs2, "REUC", "subsetB", BPPARAM )
varExplained3 <- estimateR2( crossCoefs3, "REUC", "subsetC", BPPARAM )
varExplainedJR1 <- estimateR2( crossCoefsJR1, "RSIC", "subsetA", BPPARAM )
varExplainedJR2 <- estimateR2( crossCoefsJR2, "RSIC", "subsetB", BPPARAM )
varExplainedJR3 <- estimateR2( crossCoefsJR3, "RSIC", "subsetC", BPPARAM )

varExplained <- rbind( varExplained1, varExplained2, varExplained3,
                      varExplainedJR1, varExplainedJR2, varExplainedJR3 )
rownames( varExplained ) <- NULL

```

The code below makes sure that the output of the function is the same
as the object saved in this package.

```{r}

data("varExplained")

all( head( varExplained, 5 ) ==
        estimateR2( crossCoefs1[1:5,,],
                   statistic="REUC",
                   subset="subsetA",
                   SerialParam() ) )

```

Similarly, we compute the correlation between REUCs and RSICs for the three
subsets of the __GTEx__ data. 

```{r, eval=FALSE}

estimateCors <- function( cc, ccJR, BPPARAM ){
    res <- bplapply( dimnames(cc)[["exon"]],
                    function( ex, ccL, ccJRL ){
                        cor( as.vector( ccL[ex,,] ), as.vector( ccJRL[ex,,] ) )
                    }, ccL=cc, ccJR=ccJR, BPPARAM=BPPARAM )
    names( res ) <- dimnames(cc)[["exon"]]
    unlist( res )
}

```

```{r, eval=FALSE}

BPPARAM <- SerialParam()
BPPARAM <- SnowParam(6)

cors1 <- estimateCors( crossCoefs1, crossCoefsJR1, BPPARAM )
cors2 <- estimateCors( crossCoefs2, crossCoefsJR2, BPPARAM )
cors3 <- estimateCors( crossCoefs3, crossCoefsJR3, BPPARAM )

resultsDF$corRiscReuc <- NA

for( i in 1:3 ){
    sub <- paste0( "subset", LETTERS[i] )
    corOb <- get( paste0( "cors", i ) )
    stopifnot(
        with( resultsDF[resultsDF$label == sub,],paste( gene, exon, sep=":" )  ) == names( corOb ) )
    resultsDF[resultsDF$label == sub,"corRiscReuc"] <- corOb
}
#save( resultsDF, file=file.path( path, "objects", "resultsDF.RData" ) )

```

We verify that the code indeed reproduces the correlation coefficients.

```{r}

estimateCors(
    crossCoefs1[1:10,,],
    crossCoefsJR1[1:10,,],
    SerialParam() )

```
